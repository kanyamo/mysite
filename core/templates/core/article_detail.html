{% extends "core/base/two_column_base.html" %}
{% load static %}
{% load editorjs %}
{% block title %}{{article.title}}{% endblock %}
{% block extra-styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'core/css/article_detail.css' %}">
<link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
{% endblock %}
{% block column2-1 %}
    <div class="breadcrumb-list">
        {% for category in category_list %}
        <a class="crumb-list-item" href="{% url 'core:category' category.inner_name %}">{{ category.name }}</a> >  
        {% endfor %}
        <a class="crumb-list-item" href="#">{{ article.title }}</a>
    </div>
    <h1 class="title">{{article.title}}</h1>
    <div class="article-info">
        <div class="article-view-count">{{article.view_count}} views</div>
        <div class="article-pub-date">投稿日:{{article.pub_date.year}}/{{article.pub_date.month}}/{{article.pub_date.day}}, 更新日:{{article.renew_date.year}}/{{article.renew_date.month}}/{{article.renew_date.day}}</div>
    </div>
    <img class="thumbnail-image" src="{{article.thumbnail.url}}" alt="{{article.title}}">
    作者：{{ article.author.display_name }}<br>
    <!-- article.content でJSONを展開 -->
    <div id="article-content" class="article-content">
        <!-- article.content | editorjs -->
    </div> <!-- このidはjsで使う -->
    {% if user.id == article.author.id %}
    <hr>
    <p style="text-align: center;">※以下の内容は作者としてログイン中のため表示されています。</p>
    <h2>このページのJSONデータ</h2>
    <pre class="article-json-data" id="article-json-data"></pre>
    <br>
    <div class="article-edit-button__outer">
        <a href="{% url 'core:edit' article.pk %}" class="article-edit-link">
            <div class="article-edit-button">
                この記事を編集する
            </div>
        </a>
    </div>
    {% endif %}
{% endblock %}
{% block scripts %}
<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js" integrity="sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz" crossorigin="anonymous"></script>
<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const articleContent = document.getElementById('article-content');
        let content = JSON.parse('{{ article.content|escapejs }}');
        let blocks = content.blocks;
        for (let index = 0; index < blocks.length; index++ ){
            switch(blocks[index].type){  // JSONファイルを展開し、そのブロックの各タイプごとに分解
                case 'Header':
                    let head = document.createElement(`h${blocks[index].data.level}`);
                    head.textContent = blocks[index].data.text;
                    articleContent.appendChild(head);
                    break;
                case 'Image':
                    let image_div = document.createElement('div');
                    let image = document.createElement('img');
                    let image_caption = document.createElement('p');
                    image.classList.add('content-image');
                    image_caption.classList.add('content-image-caption');
                    image.src = `{{ base_url }}${blocks[index].data.file.url}`;  // base_urlは.envで定義済み
                    image_caption.textContent = blocks[index].data.caption;
                    image_div.appendChild(image);
                    image_div.appendChild(image_caption);
                    articleContent.appendChild(image_div);
                    break;
                case 'Math':
                    let math_div = document.createElement('div');
                    math_div.classList.add('equation-container');
                    math_div.innerHTML = '\\[' + blocks[index].data.text + '\\]';
                    articleContent.appendChild(math_div);
                    break;
                case 'paragraph':
                    let p = document.createElement('p');
                    p.innerHTML = blocks[index].data.text;
                    articleContent.appendChild(p);
                    break;
                case 'List':
                    if (blocks[index].data.style == 'unordered') {
                        list = document.createElement('ul');
                    } else {
                        list = document.createElement('ol');
                    }
                    for (const item in blocks[index].data.items) {
                        let li = document.createElement('li');
                        li.innerHTML = blocks[index].data.items[item];
                        list.appendChild(li);
                    }
                    articleContent.appendChild(list);
                    break;
                case 'Code':
                    let blockquote = document.createElement('blockquote');
                    let pre = document.createElement('pre');
                    let code = document.createElement('code');
                    code.textContent = blocks[index].data.code;
                    code.classList.add('code');
                    pre.appendChild(code);
                    blockquote.appendChild(pre);
                    articleContent.appendChild(blockquote);
                    break;
                case 'Raw':
                    let container = document.createElement('div');
                    container.classList.add('raw_html_container');
                    container.innerHTML = blocks[index].data.html;
                    articleContent.append(container);
                    break;
                case 'Table':
                    let table = document.createElement('table');
                    let data = blocks[index].data.content;
                    table.classList.add('article-table');
                    let trs = [];
                    let tds = [];
                    for (let row = 0; row < data.length; row++){
                        tds = [];
                        trs.push(document.createElement('tr'));
                        for (let column = 0; column < data.length; column++){
                            tds.push(document.createElement('td'));
                            tds[column].textContent = data[row][column];
                            trs[row].appendChild(tds[column]);
                        table.appendChild(trs[row]);
                        }
                    articleContent.appendChild(table);
                    }
                    break;
                case 'Checklist':
                    let checklist_ul = document.createElement('ul');
                    checklist_ul.classList.add('checklist')
                    for (const item in blocks[index].data.items) {
                        let li = document.createElement('li');
                        li.innerHTML = blocks[index].data.items[item].text;
                        li.setAttribute('checked', blocks[index].data.items[item].checked);
                        checklist_ul.appendChild(li);
                    }
                    articleContent.appendChild(checklist_ul);
                    break;
                case 'Delimiter':
                    let hr = document.createElement('hr');
                    hr.classList.add('delimiter');
                    articleContent.appendChild(hr);
                    break;
                case 'Quote':
                    let blockQuote_container = document.createElement('div');
                    let blockQuote = document.createElement('blockquote');
                    let quote_caption = document.createElement('p');
                    blockQuote.classList.add('quote');
                    quote_caption.classList.add('quote-caption');
                    blockQuote.innerHTML = blocks[index].data.text;
                    quote_caption.innerHTML = blocks[index].data.caption;
                    blockQuote_container.appendChild(blockQuote);
                    blockQuote_container.appendChild(quote_caption);
                    articleContent.appendChild(blockQuote_container);
                    break;
                case 'Warning':
                    let warning_div = document.createElement('div');
                    warning_div.classList.add('warning-container');
                    let warning_title = document.createElement('p');
                    warning_title.classList.add('warning-title');
                    let warning_i = document.createElement('i');
                    warning_i.classList.add("fa-solid", "fa-triangle-exclamation");
                    let warning_message = document.createElement('p');
                    warning_message.classList.add('warning-message');
                    warning_title.innerHTML = " " + blocks[index].data.title;
                    warning_message.innerHTML = blocks[index].data.message;
                    warning_title.prepend(warning_i);
                    warning_div.appendChild(warning_title);
                    warning_div.appendChild(warning_message);
                    articleContent.appendChild(warning_div);

            }
        }

        renderMathInElement(document.body, {delimiters: [
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false}
        ]});  // KaTeX読み込み

        var tz = document.createElement('script');
        tz.type = 'text/javascript';
        tz.src = 'https://tikzjax.com/v1/tikzjax.js';
        document.head.appendChild(tz);  // TikZJax遅延読み込み

        // パースしたJSONデータを文字列化し、preタグの中に入れ込む
        // KaTeX読み込みより遅くすることで数式化を防ぐ
        let pre = document.getElementById("article-json-data");
        if (pre != null){
            pre.innerText = JSON.stringify(content, undefined, 4);
        }
    });
</script>
{{ block.super }}
{% endblock %}