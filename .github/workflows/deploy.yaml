name: Deploy (Django + Gunicorn + Nginx)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_DIR: ~/mysite
      VENV_DIR: ~/mysite/.venv
      DJANGO_SETTINGS_MODULE: mysite.settings.prod
      GUNICORN_SERVICE: mysite.service

    steps:
      - name: Checkout (for commit info only)
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          script_stop: true
          envs: PROJECT_DIR,VENV_DIR,DJANGO_SETTINGS_MODULE,GUNICORN_SERVICE
          script: |
            set -euo pipefail

            echo "==> cd $PROJECT_DIR"
            cd "$PROJECT_DIR"

            echo "==> Fetch latest code"
            git fetch --all --prune

            echo "==> Activate venv & install deps"
            source "$VENV_DIR/bin/activate"
            python -V
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "==> Django migrate & collectstatic"
            export DJANGO_SETTINGS_MODULE="${DJANGO_SETTINGS_MODULE}"

            python manage.py migrate --noinput
            python manage.py collectstatic --noinput

            echo "==> Restart services"
            sudo systemctl restart "$GUNICORN_SERVICE"
            sudo systemctl reload nginx

            echo "==> Done 🎉"
